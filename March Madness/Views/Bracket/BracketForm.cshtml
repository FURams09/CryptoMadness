@model March_Madness.Models.ViewModels.UserBracketViewModel
@{
	ViewBag.Title = "BracketForm";
}

<h2>Bracket Form</h2>
<div class="row">
	<select id="bracket-selector">
		<option value=0>New Bracket</option>
		@foreach (var bracket in Model.UserBrackets)
		{
			<option value=@bracket.Id>@bracket.Name</option>
		}

	</select>
</div>
<div class="row">
	<input id="bracket-name" value="@Model.TournamentEntryName"/>
	<div class="col-md-11">
		<div id="crypto-madness" style="height: 260px;"></div>
		
	</div>
	<div style="z-index:99999;">
		<button class="btn btn-primary btn-success" id="submitBracket" >Enter</button>
	</div>


</div>

@Scripts.Render("~/bundles/bracketScripts")
@section scripts
{
	<script type="text/javascript" src="~/Scripts/jquery.bracket.js"></script>
	<link rel="stylesheet" type="text/css" href="~/Content/jquery.bracket.css" />
	<script type="text/javascript">



		var teamArray = [];
		var bracketStore = {
			isNewBracketShown: true,
			newBracketNamet: '',
			newBracketData: []
		};
		$(function () {
			
			@foreach (var game in Model.TournamentTeams)
			{
				 @Html.Raw($"teamArray.push([[\"{ game[0] }\"], [\"{ game[1]}\"]]);" + Environment.NewLine);
			}


			/*randomly picked bracket put into string, then converted back */


			getTournamentBracket()


			$('#submitBracket').on('click', function () {
				//***REMOVE TRUE BEFORE GOING LIVE PL
				if (true || $('.highlightWinner').length > 0 && $('.highlightWinner .highlight').length === 0) {
					var results = $('#crypto-madness').bracket('data').results;

					var entry = {
						UserBrackets: null,
						TournamentId: $('#bracket-selector').val(),
						TournamentEntryName: $('#bracket-name').val(),
						BracketPicks: results[0],
						TournamentTeams: null
					}

					$.ajax({
						url: '/api/bracket/save',
						method: 'POST',
						data: entry,
						success: function () {
							alert('successfully added bracket');
						},
						failure: function (a, b, c, d) {
							alert('failed');
							console.log(a, b, c, d);
						}
					})
				} else {
					alert('All games must be selected.');
				}
			});

			$('#bracket-selector').on('change', function () {
				getTournamentBracket();
				if (bracketSave.isNewBracketShown) {
					//store what state the bracket currently is in
				} else if ($(this).val() == 0) {
					//repopulate with last new bracket state. 
				}
				$('#bracket-name').val('');
			})

		})

		function getTournamentBracket() {
			var bracketId = $('#bracket-selector').val();
			if (bracketId == 0) {
				fillBracket();
				 
			} else {
				$.ajax({
					url: '/api/bracket/' + bracketId,
					method: 'GET',
					success: function (res) {
						var initData = {
							teams: teamArray,
							results: res /* second round */
						}

						fillBracket(initData)
					},
					failure: function (a, b, c) {
						console.log(a, b, c);
					}
				});
			}
			
		}

		function fillBracket(data) {
			data = data || {
				teams: teamArray,
				results: []
			}
			$('#crypto-madness')
				.bracket({
					init: data, /* data to initialize the bracket with */
					skipConsolationRound: true,
					save: bracketSave,
					disableToolbar: true,
					disableTeamEdit: true,
					teamWidth: 150,
					scoreWidth: 0,
					showFinalBubble: false
				});
		}
	</script>

}


